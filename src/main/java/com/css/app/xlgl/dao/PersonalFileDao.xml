<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.css.app.xlgl.dao.PersonalFileDao">

	<select id="queryList" resultType ="com.css.app.xlgl.entity.PersonalFile">
	select 
		a.EXAMINE_SUBJECT_ID as examineSubjectId,
		a.EXAMINE_SUBJECT_NAME as examineSubjectName,
		a.examine_name as examineName,
		b.FRACTIONSUM as fractionSum,
		a.create_user as createUserId,
		b.UPDATE_DATE,
		to_char(b.UPDATE_DATE,'yyyy'),
		us.truename as userName
	from XLGL_EXAM_EXAMINE  a 
	join XLGL_EXAM_MAIN_ANSWER b 
		on a.id=b.examine_id
	left join BASE_APP_USER us 
		on a.create_user = us.id 
	where 
		1=1 
		and b.ISNOTEXAM = '1'and a.status= '0'
		and a.OVER_STATUS = '1' 
		<if test="replyUserId != null and replyUserId !=''">
			and b.REPLY_USER_ID = #{replyUserId}
		</if>
		<if test="year != null and year !=''">
			and to_char(sysdate,'yyyy')	= to_char(b.UPDATE_DATE,'yyyy')
		</if>
	</select>
	
	<select id="queryTotal" resultType="int">
		select count(a.EXAMINE_SUBJECT_ID)  
			from XLGL_EXAM_EXAMINE  a 
			join XLGL_EXAM_MAIN_ANSWER b 
			on a.id=b.examine_id
		where  
		b.ISNOTEXAM = '1'and a.status= '0'
		and a.OVER_STATUS = '1' 
		<if test="replyUserId != null and replyUserId !=''">
			and b.REPLY_USER_ID = #{replyUserId}
		</if>
		<if test="level != null and level !=''">
			and b.LEVEL = #{level}
		</if> 
		
	</select>
	
	<select id="getTitleList" resultType="com.css.app.xlgl.entity.PersonalFile">
		select 
		a.EXAMINE_SUBJECT_ID as examineSubjectId,
		a.EXAMINE_SUBJECT_NAME as examineSubjectName
		from XLGL_EXAM_EXAMINE  a 
		join XLGL_EXAM_MAIN_ANSWER b 
			on a.id=b.examine_id
		where  
		b.ISNOTEXAM = '1'and a.status= '0'
		and a.OVER_STATUS = '1' 
		<if test="replyUserId != null and replyUserId !=''">
			and b.REPLY_USER_ID = #{replyUserId}
		</if>
		<if test="level != null and level !=''">
			and b.LEVEL = #{level}
		</if> 
			group by a.EXAMINE_SUBJECT_ID,a.EXAMINE_SUBJECT_NAME;
	</select>
	
	<select id="queryListBySubjectId" resultType="com.css.app.xlgl.entity.PersonalFile">
		select 
		a.examine_name as examineName,
		a.EXAMINE_SUBJECT_ID as examineSubjectId,
		a.EXAMINE_SUBJECT_NAME as examineSubjectName,
		b.level as level
		from XLGL_EXAM_EXAMINE  a 
		join XLGL_EXAM_MAIN_ANSWER b 
			on a.id=b.examine_id
		where  
		b.ISNOTEXAM = '1'and a.status= '0'
		and a.OVER_STATUS = '1' 
		<if test="replyUserId != null and replyUserId !=''">
			and b.REPLY_USER_ID = #{replyUserId}
		</if>
		<if test="level != null and level !=''">
			and b.LEVEL = #{level}
		</if> 
		<if test="subjectId != null and subjectId !=''">
			and a.EXAMINE_SUBJECT_ID = #{subjectId}
		</if> 
		
	</select>
	
	<select id="queryRanking" resultType="com.css.app.xlgl.entity.PersonalFile">
		select 
			row_number()over (order by totalFraction desc)as ranking,
			replyUserId,
			replyUserName,
			totalFraction ,
			fractionSum
		from 
			( select 
				sum(b.FRACTIONSUM) as totalFraction,
				b.REPLY_USER_ID as replyUserId,
				b.REPLY_USER_NAME as replyUserName,
				sum(a.EXAMINE_ALL_NUMBER)as fractionSum
				from XLGL_EXAM_EXAMINE  a 
		join XLGL_EXAM_MAIN_ANSWER b 
		on a.id=b.examine_id
				where  
			 b.ISNOTEXAM = '1' and a.status= '0'
			and a.OVER_STATUS = '1'  
			group by b.REPLY_USER_ID,b.REPLY_USER_NAME) 
		
	</select>
</mapper>