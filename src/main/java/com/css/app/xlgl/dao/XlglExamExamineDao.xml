<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.css.app.xlgl.dao.XlglExamExamineDao">

	<select id="queryObject" resultType="com.css.app.xlgl.entity.XlglExamExamine">
		select * from
		XLGL_EXAM_EXAMINE where id = #{value}
	</select>

	<select id="queryList" resultType="com.css.app.xlgl.entity.XlglExamExamine">
		select * from XLGL_EXAM_EXAMINE
		where 1=1
		<if test="issueStatus != null and issueStatus !=''">
			and ISSUE_STATUS = #{issueStatus}
		</if>
		<if test="issueDate != null and issueDate !=''">
			and ISSUE_DATE &gt;= #{issueDate}
		</if>
		<if test="examineName != null and examineName !=''">
			and EXAMINE_NAME like '%'||#{examineName}||'%'
		</if>
		<if test="status != null and status !=''">
			and STATUS = #{status}
		</if>
				order by 
			(
				case 
					when 
						OVER_STATUS = '0' 
						then 0 
					when 
						OVER_STATUS = '2' then 1 
					when 
						OVER_STATUS = '99' then 2 
					when 
						OVER_STATUS = '1' then 3 
					else 4 
				end
				),
			UPDATE_DATE desc
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>

	<select id="queryListAndTotal" resultType="com.css.app.xlgl.entity.XlglExamExamine">
		select 
			x.*,
			q.queryTotal,
			w.number,
			p.MAKEUP_START_DATE,
			p.MAKEUP_END_DATE,
			p.id as makeupId 
		from 
			XLGL_EXAM_EXAMINE x
		left join
		(	select
			IFNULL(count(EXAMINE_ID),0) as queryTotal ,
			x.EXAMINE_ID
		from
			XLGL_EXAM_MAIN_ANSWER x
		left join  
			BASE_APP_USER u on x.REPLY_USER_ID = u.id
		where
			x.STATUS = '0' and (u.sfyx is null or u.sfyx = '0') group by x.EXAMINE_ID
		) q
			on q.EXAMINE_ID = x.id 
		left join
		(	select
        		IFNULL(count(REPLY_USER_ID), 0) as number ,x.EXAMINE_ID
			from
        		XLGL_EXAM_MAIN_ANSWER x
			left join 
				BASE_APP_USER u
			on
      		    x.REPLY_USER_ID = u.id
		where 1 = 1
			 and
       		(
                u.sfyx is null
             or u.sfyx  = '0'
        	)
      		<if test="isNotExam != null and isNotExam != ''">
			and x.ISNOTEXAM = #{isNotExam}
			</if>
			group by x.EXAMINE_ID
		) w
			on w.EXAMINE_ID = x.id
		left join
			XLGL_EXAM_EXAMINE_MAKEUP p
		on
		p.EXAMINE_ID = x.id
		where 1=1
		<if test="issueStatus != null and issueStatus !=''">
			and x.ISSUE_STATUS = #{issueStatus}
		</if>
		<if test="issueDate != null and issueDate !=''">
			and x.ISSUE_DATE &gt;= #{issueDate}
		</if>
		<if test="examineName != null and examineName !=''">
			and x.EXAMINE_NAME like '%'||#{examineName}||'%'
		</if>
		<if test="status != null and status !=''">
			and x.STATUS = #{status}
		</if>
		<if test="replyUserId != null and replyUserId !=''">
			and m.reply_user_id = #{replyUserId}
		</if>
		order by 
			(
				case 
					when 
						x.OVER_STATUS = '0' 
						then 0 
					when 
						x.OVER_STATUS = '2' then 1 
					when 
						x.OVER_STATUS = '99' then 2 
					when 
						x.OVER_STATUS = '1' then 3 
					else 4 
				end
				),
			x.UPDATE_DATE desc
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>
	<select id="queryTotal" resultType="int">
		select count(*) from XLGL_EXAM_EXAMINE
		where 1=1
		<if test="issueStatus != null and issueStatus !=''">
			and ISSUE_STATUS = #{issueStatus}
		</if>
		<if test="status != null and status !=''">
			and STATUS = #{status}
		</if>
		<if test="overStatus != null and overStatus !=''">
			and OVER_STATUS = #{overStatus}
		</if>

	</select>

	<insert id="save" parameterType="com.css.app.xlgl.entity.XlglExamExamine">
		insert into XLGL_EXAM_EXAMINE
		(
		"id",
		"EXAMINE_NAME",
		"EXAMINE_DATE",
		"EXAMINE_START_DATE",
		"EXAMINE_ALL_NUMBER",
		"EXAMINE_SUBJECT_ID",
		"EXAMINE_SUBJECT_NAME",
		"CREATE_USER",
		"CREATE_DATE",
		"UPDATE_USER",
		"UPDATE_DATE",
		"ISSUE_STATUS",
		"STATUS",
		"OVER_STATUS",
		"EXAMINE_END_DATE",
		"ISSUE_DATE",
		"MAKEUP_STATUS",
		"TYPE_NUM_STR",
		"LIANXI_TYPE"
		)
		values
		(
		#{id},
		#{examineName},
		#{examineDate},
		#{examineStartDate},
		#{examineAllNumber},
		#{examineSubjectId},
		#{examineSubjectName},
		#{createUser},
		#{createDate},
		#{updateUser},
		#{updateDate},
		#{issueStatus},
		#{status},
		#{overStatus},
		#{examineEndDate},
		#{issueDate},
		#{makeupStatus},
		#{typeNumStr},
		#{lianxiType}
		)
	</insert>

	<update id="update" parameterType="com.css.app.xlgl.entity.XlglExamExamine">
		update XLGL_EXAM_EXAMINE
		<set>
			<if test="examineName != null">"EXAMINE_NAME" = #{examineName}, </if>
			<if test="examineDate != null">"EXAMINE_DATE" = #{examineDate}, </if>
			<if test="examineStartDate != null">"EXAMINE_START_DATE" = #{examineStartDate}, </if>
			<if test="examineAllNumber != null">"EXAMINE_ALL_NUMBER" = #{examineAllNumber}, </if>
			<if test="examineSubjectId != null">"EXAMINE_SUBJECT_ID" = #{examineSubjectId}, </if>
			<if test="examineSubjectName != null">"EXAMINE_SUBJECT_NAME" = #{examineSubjectName}, </if>
			<if test="createUser != null">"CREATE_USER" = #{createUser}, </if>
			<if test="createDate != null">"CREATE_DATE" = #{createDate}, </if>
			<if test="updateUser != null">"UPDATE_USER" = #{updateUser}, </if>
			<if test="updateDate != null">"UPDATE_DATE" = #{updateDate}, </if>
			<if test="issueStatus != null">"ISSUE_STATUS" = #{issueStatus}, </if>
			<if test="status != null">"STATUS" = #{status}, </if>
			<if test="examineEndDate != null">"EXAMINE_END_DATE" = #{examineEndDate}, </if>
			<if test="issueDate != null">"ISSUE_DATE" = #{issueDate}, </if>
			<if test="lianxiType != null">"LIANXI_TYPE" = #{lianxiType}, </if>
			<if test="makeupStatus != null">"MAKEUP_STATUS" = #{makeupStatus}, </if>
			<if test="typeNumStr != null">"TYPE_NUM_STR" = #{typeNumStr}, </if>
			<if test="overStatus != null">"OVER_STATUS" = #{overStatus} </if>
		</set>
		where id = #{id}
	</update>

	<delete id="delete">
		delete from XLGL_EXAM_EXAMINE where id = #{value}
	</delete>

	<delete id="deleteBatch">
		delete from XLGL_EXAM_EXAMINE where id in
		<foreach item="id" collection="array" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</delete>

	<select id="findCount" resultType="int">
		select
		count(*)
		from
		XLGL_EXAM_MAIN_ANSWER x
		left join  BASE_APP_USER u on x.REPLY_USER_ID = u.id
		where
		x.STATUS = '0' and (u.sfyx is null or u.sfyx = '0')
		<if test="examineId != null and examineId !=''">
			and x.EXAMINE_ID = #{examineId}
		</if>
		<if test="organIdList != null">
			and x.ORGAN_ID in
			<foreach item="id" collection="organIdList" open="("
				separator="," close=")">
				#{id}
			</foreach>
		</if>

	</select>

	<select id="queryVerifyList" resultType="com.css.app.xlgl.entity.XlglExamExamine">
		select * from XLGL_EXAM_EXAMINE
		where STATUS = '0' and ISSUE_STATUS =
		'1'
		<if test="examineName != null and examineName !=''">
			and EXAMINE_NAME = #{examineName}
		</if>
		order by UPDATE_DATE desc
	</select>
</mapper>